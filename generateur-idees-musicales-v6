<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur d'id√©es musicales V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00695c;
            --primary-dark: #004d40;
            --secondary: #b2dfdb;
            --accent: #d32f2f;
            --bg-gradient: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px rgba(0, 77, 64, 0.1);
            
            /* Couleur unique pour les sections */
            --section-title-color: var(--primary-dark); 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-gradient);
            color: var(--primary-dark);
        }

        .container, .result, .manage-section, .result-section-group {
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            border: 1px solid var(--primary);
            padding: 25px;
            border-radius: 15px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        
        .result {
            display: flex;
            flex-direction: column;
            gap: 25px; /* Espace entre les groupes de sections */
            padding: 25px 25px 5px 25px; /* Ajustement du padding bas */
        }

        .result-section-group {
            padding: 0;
            border: none;
            background: none;
            box-shadow: none;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-dark);
            font-size: 1.8em;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* STYLE POUR LES TITRES DE SECTION (Couleur unique) */
        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--primary); /* Bordure plus fine */
            color: var(--section-title-color); /* Texte vert fonc√© */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Boutons */
        button {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 77, 64, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 77, 64, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        button.danger {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Resultats */
        .result-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 105, 92, 0.1);
        }

        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .result-value-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 2;
            justify-content: flex-end;
        }

        .result-value {
            padding: 8px 15px;
            background: linear-gradient(135deg, #b2dfdb 0%, #80cbc4 100%);
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: right;
            min-width: 100px;
            display: flex;
            justify-content: center;
            /* Permet le retour √† la ligne pour les multiples √©l√©ments */
            white-space: normal; 
            text-align: center;
        }

        /* Lock Button */
        .lock-btn {
            background: none;
            box-shadow: none;
            padding: 5px;
            color: #ccc;
            min-width: auto;
            border: 1px solid transparent;
        }
        .lock-btn:hover {
            background: none;
            transform: scale(1.1);
            color: var(--primary);
            box-shadow: none;
        }
        .lock-btn.locked {
            color: var(--accent);
        }

        .spinning {
            animation: spin 0.5s ease-in-out;
        }

        @keyframes spin {
            0% { transform: rotateX(0deg); opacity: 0.5; }
            50% { transform: rotateX(90deg); opacity: 0.3; }
            100% { transform: rotateX(0deg); opacity: 1; }
        }

        /* Inputs & Forms */
        select, input[type="text"], input[type="number"] { /* Ajout input[type="number"] */
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid var(--secondary);
            width: 100%;
            margin-top: 8px;
            margin-bottom: 15px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        input[type="number"] {
             max-width: 150px; /* Limiter la largeur des inputs num√©riques */
             text-align: center;
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Specific margin for part select */
        label[for="new-category-part"] {
            display: block; 
            margin-top: 10px;
            font-weight: bold;
        }

        /* List Items (Tags) */
        .list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .list-item {
            padding: 6px 12px;
            border: 1px solid var(--secondary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #e0f2f1;
            font-size: 0.9em;
        }

        .list-item span.delete-btn {
            cursor: pointer;
            color: var(--accent);
            font-weight: bold;
            font-size: 1.2em;
        }

        .list-item span.delete-btn:hover {
            color: #b71c1c;
        }

        /* Accordion / Collapsible */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            user-select: none;
        }
        .collapsible-header:hover {
            opacity: 0.8;
        }
        .collapsible-content {
            display: none;
            padding-top: 15px;
            border-top: 1px solid #eee;
            animation: slideDown 0.3s ease-out;
        }
        .collapsible-content.active {
            display: block;
        }
        .arrow {
            transition: transform 0.3s ease;
        }
        .active .arrow {
            transform: rotate(180deg);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Messages */
        .error-message { color: var(--accent); display: none; margin-top: 5px; font-size: 0.9em;}
        .success-message { color: #2e7d32; display: none; margin-top: 5px; font-size: 0.9em;}

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fff;
            margin: 10vh auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        .modal-scrollable-content {
            max-height: 40vh;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--secondary);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .history-modal .modal-content { max-width: 700px; max-height: 80vh; overflow-y: auto; }
        
        .history-item {
            background-color: #f5f5f5;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }

        /* Checkbox styles for clear lists modal */
        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .checkbox-label:hover {
            background-color: #eee;
        }
        input[type="checkbox"] {
            margin-right: 10px;
            min-width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }


        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--primary-dark);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .result-row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .result-value-container { width: 100%; justify-content: space-between; }
            .button-group { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>G√©n√©rateur d'id√©es musicales</h1>
        <div class="button-group">
            <button onclick="tirer()">üé≤ Lancer le d√©</button>
            <button class="secondary" onclick="copierResultat()">üìã Copier</button>
            <button class="secondary" onclick="sauvegarderTirage()">üíæ Sauver</button>
            <button class="secondary" onclick="afficherHistorique()">üìö Historique</button>
        </div>
    </div>

    <!-- Zone de r√©sultat dynamique -->
    <div class="result" id="result-container">
        <!-- Le contenu sera g√©n√©r√© par JS, structur√© en sections -->
    </div>
    
    <!-- Section Options de Tirage (Pliable) -->
    <div class="manage-section">
        <div class="collapsible-header" onclick="toggleSection('options-section')">
            <h2>‚öôÔ∏è Options de tirage</h2>
            <span class="arrow">‚ñº</span>
        </div>
        <div id="options-section" class="collapsible-content">
            <p style="margin-bottom: 15px; color: #555;">S√©lectionnez le nombre d'√©l√©ments √† tirer pour les cat√©gories sp√©cifiques (entre 1 et 5). Les r√©sultats multiples seront s√©par√©s par un `|`.</p>

            <label for="count-figures" style="display: block; margin-top: 10px; font-weight: bold;">Figure (Nombre d'id√©es):</label>
            <input type="number" id="count-figures" min="1" max="5" value="1" onchange="updateDrawCount('figures', this.value)">

            <label for="count-suites" style="display: block; margin-top: 10px; font-weight: bold;">Suite d‚Äôaccords (Nombre d'id√©es):</label>
            <input type="number" id="count-suites" min="1" max="5" value="1" onchange="updateDrawCount('suites', this.value)">

            <label for="count-modulations" style="display: block; margin-top: 10px; font-weight: bold;">Modulation (Nombre d'id√©es):</label>
            <input type="number" id="count-modulations" min="1" max="5" value="1" onchange="updateDrawCount('modulations', this.value)">
        </div>
    </div>

    <!-- Section Ajout (Pliable) -->
    <div class="manage-section">
        <div class="collapsible-header" onclick="toggleSection('add-section')">
            <h2>‚ûï Ajouter des √©l√©ments</h2>
            <span class="arrow">‚ñº</span>
        </div>
        <div id="add-section" class="collapsible-content">
            <label for="category">Cat√©gorie:</label>
            <select id="category"></select>
            
            <label for="new-item">Nouveaux √©l√©ments (s√©par√©s par virgules):</label>
            <input type="text" id="new-item" placeholder="Ex: Romantique, √ânergique, Jazz Fusion">
            
            <div class="button-group">
                <button onclick="ajouterElements()">Ajouter</button>
            </div>
            <div class="error-message" id="add-error"></div>
            <div class="success-message" id="add-success"></div>
        </div>
    </div>

    <!-- Section Gestion (Pliable) -->
    <div class="manage-section">
        <div class="collapsible-header" onclick="toggleSection('manage-section')">
            <h2>üóÇÔ∏è G√©rer les cat√©gories</h2>
            <span class="arrow">‚ñº</span>
        </div>
        <div id="manage-section" class="collapsible-content">
            <label for="manage-category">Voir la cat√©gorie:</label>
            <select id="manage-category" onchange="afficherElements()"></select>
            
            <div id="items-list" class="list-container"></div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <h3>Nouvelle cat√©gorie</h3>
            <input type="text" id="new-category-name" placeholder="Nom de la cat√©gorie (ex: Instruments)">
            
            <label for="new-category-part">Partie d'appartenance:</label>
            <select id="new-category-part"></select>

            <button onclick="ajouterCategorie()" style="width: 100%; margin-bottom: 10px;">Ajouter</button>
            <div class="error-message" id="category-error"></div>
            <div class="success-message" id="category-success"></div>

            <div style="margin-top: 20px;">
                <h3>Cat√©gories existantes</h3>
                <div id="categories-list"></div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <a href="javascript:void(0);" onclick="showClearListsSelectionModal()" style="color: var(--primary); font-size: 0.8em; text-decoration: none;">‚ö†Ô∏è Vider les listes (S√©lection)</a>
                 | 
                <a href="javascript:void(0);" onclick="showFullResetModal()" style="color: var(--primary); font-size: 0.8em; text-decoration: none;">‚ôªÔ∏è Restaurer les listes d'origine</a>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirmation</h2>
            <p id="modal-message"></p>
            <div class="button-group">
                <button onclick="confirmAction()">Oui</button>
                <button class="secondary" onclick="closeModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modale pour la s√©lection des listes √† vider -->
    <div id="clearListsModal" class="modal">
        <div class="modal-content">
            <h2>S√©lectionner les listes √† vider</h2>
            <p style="margin-bottom: 15px;">Cochez les cat√©gories dont vous souhaitez supprimer TOUS les √©l√©ments. Les cat√©gories vides seront conserv√©es.</p>
            <div id="clearListsCheckboxes" class="modal-scrollable-content">
                <!-- Checkboxes inject√©es ici par JS -->
            </div>
            <div class="button-group">
                <button class="danger" onclick="clearSelectedLists()">Vider les listes s√©lectionn√©es</button>
                <button class="secondary" onclick="closeModal('clearListsModal')">Annuler</button>
            </div>
        </div>
    </div>


    <div id="historyModal" class="modal history-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>üìö Historique</h2>
                <button class="secondary" onclick="closeHistoryModal()" style="padding: 5px 10px;">‚úï</button>
            </div>
            <div id="history-list"></div>
            <div style="margin-top:20px; text-align:center;">
                <button class="danger" onclick="showClearHistoryModal()">Tout effacer</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- DONN√âES PAR D√âFAUT (MISES √Ä JOUR AVEC VOTRE FICHIER CSV ET CORRIG√âES) ---
        const defaultData = {
            // Cat√©gories du CSV (Ambiance, Structure, Signature, Style, Figure)

            ambiances: ["Joie", "M√©lancolie", "Triste", "Myst√®re", "√âpique", "Qui√©tude", "Planant", "Fuite", "Peur", "Combat", "Col√®re", "Sombre"],

            structures: ["C R","C R C","C R C P C R C","C C R R","C R P C","C R C R","C C R","C R C P C","C R P","C R C R P R","C C R R C","C R C R C P","C C C","C C R C R R P R O","I C C PR R C PR R S PR R R","I C C PR R S P PR R S R O","I C PR R C PR  R P S PR R O","I C PR C PR R P/S R"],

            signatures: ["4/4","3/4","6/8","12/8","5/4","7/8","9/8","2/4","3/8","5/8","7/4","11/8","6/4","4/8","2/2","3/2","9/4","12/4","5/2","7/2"],

            figures: ["blanche | noire | noire","noire | blanche | noire","noire | noire | blanche","noire | noire | noire | noire","blanche | 2 croches | 2 croches,"2 croches | 2 croches | blanche","noire | noire | 4 croches","4 croches | noire | noire","noire | 4 croches | noire","4 croches | noire | 2 croches | 2 croches",
"noire | noire | noire | 2 croches | 2 croches","noire | 2 croches | 2 croches | noire | noire","2 croches | 2 croches | noire | noire | noire","2 croches | 2 croches | 2 croches | 2 croches","blanche point√©e | noire","demi‚Äësoupir | noire noire | noire","noire | demi‚Äësoupir | noire | noire",
"noire | noire demi‚Äësoupir | noire","noire | noire | noire demi‚Äësoupir","soupir | noire | noire | noire","noire | soupir | noire | noire","noire | noire | soupir | noire","noire | noire | noire | soupir","blanche | soupir | noire","soupir | blanche | noire","noire | blanche | soupir","soupir | blanche | soupir","soupir | blanche | noire","blanche | soupir | soupir","demi‚Äësoupir | 2 croches | noire | noire",
"noire | 2 croches | demi‚Äësoupir | noire","2 croches | demi‚Äësoupir | 2 croches | noire","2 croches | 2 croches | demi‚Äësoupir | noire","noire | soupir | 2 croches | 2 croches","2 croches | 2 croches | soupir | noire","soupir | 4 croches | noire","4 croches | soupir | noire","soupir | soupir | blanche","demi‚Äësoupir | 4 croches | 2 croches | 2 croches","4 croches | 2 croches | 2 croches | demi‚Äësoupir"],

            styles: ["Metal","Rock","Hardrock","Chanson √† texte","Jazz","Electro","Blues","Ambiant","Lo-Fi","Classique","Folk","Funk","Disco","Reggae"],
            
            instruments: ["Piano classique","Guitare classique","Guitare folk","Guitare √©lectrique","Synth√©tiseur","Flute","Tambour","Violon","Fl√ªte traversi√®re","Saxophone","Batterie","Trompette","Clarinette","Harmonica","Violoncelle","Xylophone / Marimba","Harpe","Piano √©lectrique","Guitare basse","Accord√©on","Orgue","Trombone","Tuba","Bongos","Caj√≥n","Congas","Darbouka","Djembe"],

            tonalites: ["Do ‚Ä¢ C", "Do# / R√©b ‚Ä¢ C#/Db", "R√© ‚Ä¢ D", "R√©# / Mib ‚Ä¢ D#/Eb", "Mi ‚Ä¢ E", "Fa ‚Ä¢ F", "Fa# / Solb ‚Ä¢ F#/Gb", "Sol ‚Ä¢ G", "Sol# / Lab ‚Ä¢ G#/Ab", "La ‚Ä¢ A", "La# / Sib ‚Ä¢ A#/Bb", "Si ‚Ä¢ B"],

            majeurmineur: ["Majeur", "mineur"],

            qualites: ["Triade","T√©trade","Powercord","Enrichi","Alt√©r√©","Suspendu"],

            suites: ["2‚Ä¢5‚Ä¢1", "1‚Ä¢4‚Ä¢1‚Ä¢5", "1‚Ä¢5‚Ä¢6‚Ä¢4", "1‚Ä¢4‚Ä¢5‚Ä¢4", "1‚Ä¢6‚Ä¢2‚Ä¢5", "1‚Ä¢6‚Ä¢4‚Ä¢5", 2‚Ä¢3‚Ä¢6‚Ä¢5, "1‚Ä¢2‚Ä¢4‚Ä¢5","1‚Ä¢6‚Ä¢3‚Ä¢5","1‚Ä¢3‚Ä¢4‚Ä¢5","1‚Ä¢7‚Ä¢4‚Ä¢1","1‚Ä¢5‚Ä¢6‚Ä¢3","2‚Ä¢4‚Ä¢1‚Ä¢5","1‚Ä¢4‚Ä¢7‚Ä¢4","1‚Ä¢3‚Ä¢6‚Ä¢2","1‚Ä¢7‚Ä¢6‚Ä¢5","2‚Ä¢3‚Ä¢2‚Ä¢5","2‚Ä¢5‚Ä¢3‚Ä¢5","2‚Ä¢3‚Ä¢2‚Ä¢5", "2‚Ä¢5‚Ä¢3‚Ä¢5"],

            modes: ["Dorien", "Phrygien", "Lydien", "Mixolydien", "√âolien", "Locrien", "Harmonique mineur", "Harmonique majeur", "Acoustique espagnol", "Byzantine", "Pentatonique mineur,", "Pentatonique majeur", "Flamenco", "Hirajoshi", "In Sen", "Iwato", "Kumoi", "Pelog", "Double harmonique"],

            modulations: ["Accord pivot","Glissement chromatique de notes,"Dominante  secondaire ‚Ä¢ V de V","Dominante  secondaire ‚Ä¢ IV de IV","Dominante  secondaire ‚Ä¢ III de III","Dominante  secondaire ‚Ä¢ VI de VI","Accord d‚Äôemprunt","Dominante  chromatique","Chromatique par l‚Äôaccord de m√©diante","Harmonie n√©gative","Tritonique","Note pivot","Par le V‚Ä¢I","Par gammes relatives","D‚Äôun demi-ton ou d‚Äôun ton","Par rupture","√Ä 11h45 sur cycle des quintes","√Ä partir du degr√© I","Avec accord parall√®le vers cadence parfaite","Par accord diminu√©","Changement tonal","Par l‚Äôarmure","Aucune"]
        };

        const defaultCategories = {
            ambiances: { label: "Ambiance", icon: "üé≠" },
            styles: { label: "Style musical", icon: "üé∏" },
            structures: { label: "Structure", icon: "üèóÔ∏è" },
            tonalites: { label: "Tonalit√©", icon: "üéπ" },
            modes: { label: "Mode/Gamme", icon: "üé∂" },
            qualites: { label: "Qualit√© d'accord", icon: "üéº" },
            suites: { label: "Suite d‚Äôaccords", icon: "‚û°Ô∏è" },
            signatures: { label: "Signature", icon: "‚úçüèª" }, 
            figures: { label: "Figure", icon: "‚ô©" }, 
            instruments: { label: "Instruments ma√Ætre", icon: "üéπ" },
            majeurmineur: { label: "Majeur ou mineur", icon: "‚òØÔ∏è" },
            modulations: { label: "Modulation", icon: "‚ûø" }
        };

        // --- STRUCTURE DE SECTIONS PAR D√âFAUT (Cl√©s internes pour le JS) ---
        const defaultCategorySections = {
            style: { 
                label: "Style", 
                keys: ['ambiances', 'styles', 'instruments', 'structures'] 
            },
            temporal: { 
                label: "Rythmique", 
                keys: ['signatures', 'figures'] 
            },
            harmony: { 
                label: "Harmonie", 
                keys: ['tonalites', 'majeurmineur', 'modes', 'qualites', 'suites', 'modulations'] 
            }
        };

        // Mapping pour lier les labels utilisateur aux cl√©s internes de section
        const partToKeyMap = {
            'Style': 'style',
            'Rythmique': 'temporal',
            'Harmonie': 'harmony'
        };
        
        // Cl√©s qui doivent tirer plusieurs √©l√©ments
        const multipleDrawKeys = ['figures', 'suites', 'modulations'];

        // --- √âTAT GLOBAL ---
        let data = {};
        let categories = {};
        let categorySectionsState = {}; // L'√©tat des sections qui peut √™tre modifi√©
        let currentDraw = { results: {} };
        let drawHistory = [];
        let lockedFields = {}; 
        let modalCallback = null;
        
        // NOUVEAU: √âtat des options de tirage (nombre d'√©l√©ments)
        let drawCounts = {
            figures: 1,
            suites: 1,
            modulations: 1
        };

        // --- INITIALISATION ---
        window.onload = function() {
            initData();
            updateResultDOM();
            updateCategorySelects();
            afficherCategories(); 
            afficherElements();
            populateCategoryPartSelect(); 
            
            // Set initial values for the new number inputs
            document.getElementById('count-figures').value = drawCounts.figures;
            document.getElementById('count-suites').value = drawCounts.suites;
            document.getElementById('count-modulations').value = drawCounts.modulations;
            
            if(Object.keys(currentDraw.results).length === 0) {
                tirer();
            }
        };

        function initData() {
            // Cl√©s de stockage mises √† jour pour ne pas m√©langer les anciennes donn√©es avec la nouvelle structure V4
            const sData = localStorage.getItem('musicData_v4');
            const sCats = localStorage.getItem('musicCats_v4');
            const sHist = localStorage.getItem('musicHist_v4');
            const sSections = localStorage.getItem('musicSections_v4'); 
            const sCounts = localStorage.getItem('musicDrawCounts_v4'); // NOUVEAU
            
            data = sData ? JSON.parse(sData) : JSON.parse(JSON.stringify(defaultData));
            categories = sCats ? JSON.parse(sCats) : JSON.parse(JSON.stringify(defaultCategories));
            drawHistory = sHist ? JSON.parse(sHist) : [];
            // Utiliser la structure sauvegard√©e ou celle par d√©faut
            categorySectionsState = sSections ? JSON.parse(sSections) : JSON.parse(JSON.stringify(defaultCategorySections));
            // Chargement des comptes de tirage
            drawCounts = sCounts ? JSON.parse(sCounts) : drawCounts;

            // S'assurer que les labels par d√©faut sont √† jour et que les nouvelles cat√©gories sont pr√©sentes
            Object.keys(defaultCategories).forEach(key => {
                // MAJ des propri√©t√©s (label, icon) des cat√©gories par d√©faut
                if (categories[key]) {
                    // On ne met √† jour que si la valeur n'a pas √©t√© modifi√©e par l'utilisateur
                    if(defaultCategories[key].label !== categories[key].label) {
                        // Si le label est diff√©rent, on assume que l'utilisateur l'a modifi√© et on ne touche pas
                        // Mais on assure que l'ic√¥ne est l√†
                        categories[key].icon = categories[key].icon || defaultCategories[key].icon;
                    } else {
                         // Sinon, on s'assure que tout est conforme aux valeurs par d√©faut
                         categories[key].label = defaultCategories[key].label;
                         categories[key].icon = defaultCategories[key].icon;
                    }
                } else {
                    categories[key] = defaultCategories[key];
                }

                // S'assurer que les donn√©es existent pour la nouvelle cat√©gorie
                if (!data[key]) {
                    data[key] = defaultData[key] || [];
                }
            });

            // S'assurer que les cl√©s de sections correspondent aux nouvelles cat√©gories
            Object.keys(defaultCategorySections).forEach(sectionKey => {
                const defaultKeys = defaultCategorySections[sectionKey].keys;
                const currentKeys = categorySectionsState[sectionKey].keys;

                // Ajouter toutes les cl√©s par d√©faut qui n'existent pas dans l'√©tat actuel
                defaultKeys.forEach(key => {
                    if (!currentKeys.includes(key)) {
                        currentKeys.push(key);
                    }
                });
                
                // Nettoyer les cl√©s qui n'existent plus du tout (au cas o√π l'utilisateur en aurait ajout√©/supprim√©)
                categorySectionsState[sectionKey].keys = currentKeys.filter(key => categories[key]);
            });


            saveData();
            saveCategories();
            saveSections();
            saveDrawCounts(); // Sauvegarde des comptes de tirage
        }

        // --- SAUVEGARDES ---
        function saveData() { localStorage.setItem('musicData_v4', JSON.stringify(data)); }
        function saveCategories() { localStorage.setItem('musicCats_v4', JSON.stringify(categories)); }
        function saveHistory() { localStorage.setItem('musicHist_v4', JSON.stringify(drawHistory)); }
        function saveSections() { localStorage.setItem('musicSections_v4', JSON.stringify(categorySectionsState)); } 
        function saveDrawCounts() { localStorage.setItem('musicDrawCounts_v4', JSON.stringify(drawCounts)); }

        // --- LOGIQUE METIER ---
        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function getRandomElement(arr) { return arr.length ? arr[Math.floor(Math.random() * arr.length)] : "?"; }
        
        function getRandomDuration() {
            const m = getRandomInt(2, 8);
            const s = getRandomInt(0, 59);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
        
        // NOUVEAU: Fonction pour obtenir N √©l√©ments uniques al√©atoires
        function getRandomUniqueElements(arr, count) {
            if (count <= 0 || arr.length === 0) return ["?"];
            if (count >= arr.length) return arr; // Retourne tout si la demande est >= taille du tableau

            const shuffled = arr.slice().sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        // NOUVEAU: Mise √† jour du compte de tirage
        function updateDrawCount(key, value) {
            let num = parseInt(value, 10);
            if (isNaN(num) || num < 1) num = 1;
            if (num > 5) num = 5;
            
            drawCounts[key] = num;
            // Aussi mise √† jour de l'√©l√©ment input pour refl√©ter le clipping (1-5)
            const inputEl = document.getElementById(`count-${key}`);
            if (inputEl) inputEl.value = num;
            saveDrawCounts();
            showToast(`Nombre pour "${categories[key].label}" mis √† jour √† ${num}.`);
        }

        // Construit le DOM pour l'affichage des r√©sultats (utilise categorySectionsState)
        function updateResultDOM() {
            const container = document.getElementById('result-container');
            if (!container) return; 

            container.innerHTML = '';

            // Ordre des sections pour l'affichage : Style, Rythmique, Harmonie
            const sectionOrder = ['style', 'temporal', 'harmony']; 

            // It√©ration sur les groupes de sections dans l'ordre d√©fini
            sectionOrder.forEach(sectionKey => {
                const section = categorySectionsState[sectionKey];
                if (!section) return; // S√©curit√© si la section n'existe pas

                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'result-section-group';
                
                // Titre de la section
                const title = document.createElement('h2');
                title.className = `section-title`;
                title.innerHTML = `${section.label}`;
                sectionContainer.appendChild(title);

                let rowsHtml = '';
                // Utilise les cl√©s dynamiques de la section
                const allKeys = [...section.keys];
                
                // Ajout des champs statiques (Dur√©e, Tempo) uniquement dans la section Rythmique (temporal)
                if (sectionKey === 'temporal') {
                    allKeys.push('tempo');
                    allKeys.push('duree');
                }

                // G√©n√©ration des lignes de r√©sultats pour chaque cl√© dans la section
                allKeys.forEach((key, index) => {
                    const cat = categories[key] || { label: key, icon: '' }; 
                    const isLocked = lockedFields[key] ? 'locked' : '';
                    const lockIcon = lockedFields[key] ? 'üîí' : 'üîì';
                    
                    let label = cat.label;
                    let icon = cat.icon;
                    
                    // Gestion des champs statiques et MAJ des libell√©s
                    if (key === 'duree') { label = 'Dur√©e'; icon = '‚è±Ô∏è'; }
                    if (key === 'tempo') { label = 'Tempo'; icon = '‚ö°'; }

                    rowsHtml += `
                    <div class="result-row" data-key="${key}" ${index === allKeys.length - 1 ? 'style="border-bottom: none;"' : ''}>
                        <div class="result-label">${icon} ${label}</div>
                        <div class="result-value-container">
                            <span id="res-${key}" class="result-value">-</span>
                            <button class="lock-btn ${isLocked}" onclick="toggleLock('${key}')" title="Verrouiller ce param√®tre">${lockIcon}</button>
                        </div>
                    </div>`;
                });
                
                sectionContainer.innerHTML += rowsHtml;
                container.appendChild(sectionContainer);
            });
            
            // Remet les valeurs si elles existent
            if(currentDraw.results) {
                applyValuesToDOM(currentDraw.results);
            }
        }

        function toggleLock(key) {
            lockedFields[key] = !lockedFields[key];
            updateResultDOM();
        }

        function tirer() {
            let delay = 0;
            const now = new Date();
            currentDraw.date = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

            // 1. Cat√©gories dynamiques
            Object.keys(categories).forEach(key => {
                if (!lockedFields[key]) {
                    let val;
                    
                    if (multipleDrawKeys.includes(key)) {
                        // G√®re le tirage multiple pour les cat√©gories sp√©cifi√©es
                        const count = drawCounts[key] || 1;
                        const elements = getRandomUniqueElements(data[key] || [], count);
                        // Stocke sous forme de cha√Æne jointe pour l'affichage/copie
                        val = elements.join(' | '); 
                        
                    } else {
                        // G√®re le tirage simple (par d√©faut)
                        val = getRandomElement(data[key] || []);
                    }
                    
                    currentDraw.results[key] = val;
                    animateValue(`res-${key}`, val, delay);
                    delay += 50;
                }
            });

            // 2. Champs fixes (Temporel)
            if (!lockedFields['duree']) {
                const dur = getRandomDuration();
                currentDraw.results['duree'] = dur;
                animateValue('res-duree', dur, delay);
            }
            
            if (!lockedFields['tempo']) {
                const tempo = getRandomInt(60, 180);
                currentDraw.results['tempo'] = tempo;
                animateValue('res-tempo', tempo, delay);
            }
        }

        function applyValuesToDOM(results) {
            Object.keys(results).forEach(key => {
                const el = document.getElementById(`res-${key}`);
                if (el) el.innerText = results[key];
            });
        }

        function animateValue(id, value, delay) {
            const el = document.getElementById(id);
            if (!el) return;
            
            setTimeout(() => {
                el.innerText = value;
                el.classList.add('spinning');
                setTimeout(() => el.classList.remove('spinning'), 500);
            }, delay);
        }

        // --- GESTION AJOUTS ---
        function updateCategorySelects() {
            const selects = ['category', 'manage-category'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if(sel) {
                    sel.innerHTML = '';
                    Object.keys(categories).forEach(key => {
                        const opt = document.createElement('option');
                        opt.value = key;
                        opt.text = categories[key].label;
                        sel.appendChild(opt);
                    });
                }
            });
        }
        
        // Remplir la liste des parties pour la cr√©ation de cat√©gorie
        function populateCategoryPartSelect() {
            const sel = document.getElementById('new-category-part');
            if(!sel) return;
            sel.innerHTML = '';
            
            Object.keys(partToKeyMap).forEach(label => {
                const opt = document.createElement('option');
                opt.value = partToKeyMap[label]; // La valeur est la cl√© interne (ex: 'style')
                opt.text = label; // Le texte est le label utilisateur (ex: 'Style')
                sel.appendChild(opt);
            });
        }

        function ajouterElements() {
            const cat = document.getElementById('category').value;
            const input = document.getElementById('new-item');
            const items = input.value.split(',').map(s => s.trim()).filter(s => s);
            const errorDiv = document.getElementById('add-error');
            const successDiv = document.getElementById('add-success');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (items.length === 0) {
                errorDiv.innerText = "Veuillez entrer au moins un √©l√©ment.";
                errorDiv.style.display = 'block';
                return;
            }

            if (!data[cat]) data[cat] = [];
            
            let addedCount = 0;
            items.forEach(item => {
                if (!data[cat].includes(item)) {
                    data[cat].push(item);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                saveData();
                input.value = '';
                successDiv.innerText = `${addedCount} √©l√©ment(s) ajout√©(s) √† ${categories[cat].label} !`;
                successDiv.style.display = 'block';
                afficherElements(); // Refresh view list if visible
            } else {
                errorDiv.innerText = "Ces √©l√©ments existent d√©j√†.";
                errorDiv.style.display = 'block';
            }
        }

        // --- GESTION CAT√âGORIES ---
        function ajouterCategorie() {
            const name = document.getElementById('new-category-name').value.trim();
            const partKey = document.getElementById('new-category-part').value; // R√©cup√®re la cl√© de section (ex: 'style')
            
            const errorDiv = document.getElementById('category-error');
            const successDiv = document.getElementById('category-success');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!name) {
                errorDiv.innerText = "Nom de cat√©gorie requis.";
                errorDiv.style.display = 'block';
                return;
            }
            
            // Cr√©ation d'un ID simplifi√©
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (categories[id] || data[id]) {
                errorDiv.innerText = "Cette cat√©gorie existe d√©j√† (ID conflit).";
                errorDiv.style.display = 'block';
                return;
            }

            // Ajout
            categories[id] = { label: name, icon: 'üè∑Ô∏è' };
            data[id] = [];
            
            // Ajout √† la section correspondante
            if (categorySectionsState[partKey]) {
                categorySectionsState[partKey].keys.push(id);
            } else {
                 // Fallback si jamais la cl√© n'est pas trouv√©e (ne devrait pas arriver)
                 categorySectionsState['style'].keys.push(id);
            }

            saveCategories();
            saveData();
            saveSections(); // Sauvegarde de la structure des sections

            updateCategorySelects();
            document.getElementById('new-category-name').value = '';
            
            successDiv.innerText = `Cat√©gorie "${name}" cr√©√©e dans la partie s√©lectionn√©e !`;
            successDiv.style.display = 'block';
            
            // Mise √† jour de l'affichage
            afficherCategories();
            updateResultDOM(); // Reconstruit l'interface principale
        }

        // Affiche la liste des cat√©gories avec bouton de suppression
        function afficherCategories() {
            const container = document.getElementById('categories-list');
            if(!container) return;
            
            container.innerHTML = '';
            
            // On it√®re sur les sections pour afficher les cat√©gories group√©es (optionnel, mais plus clair)
            // Ou simplement lister tout. Ici, listons tout en indiquant la section.
            
            const list = document.createElement('div');
            list.className = 'list-container';
            
            Object.keys(categories).forEach(catId => {
                // Trouver √† quelle section appartient cette cat√©gorie
                let sectionLabel = "Aucune";
                Object.values(categorySectionsState).forEach(sec => {
                    if(sec.keys.includes(catId)) sectionLabel = sec.label;
                });
                
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    ${categories[catId].icon} <strong>${categories[catId].label}</strong> <small>(${sectionLabel})</small>
                    <span class="delete-btn" onclick="confirmerSuppressionCategorie('${catId}')" title="Supprimer">√ó</span>
                `;
                list.appendChild(div);
            });
            
            container.appendChild(list);
        }

        function confirmerSuppressionCategorie(catId) {
            // Emp√™cher la suppression des cat√©gories par d√©faut 'styles', 'ambiances' etc si on veut √™tre strict, 
            // mais ici on autorise tout sauf si bug.
            showModal(`Voulez-vous vraiment supprimer la cat√©gorie "${categories[catId].label}" et toutes ses donn√©es ?`, () => {
                supprimerCategorie(catId);
            });
        }

        function supprimerCategorie(catId) {
            delete categories[catId];
            delete data[catId];
            
            // Retirer de la section
            Object.keys(categorySectionsState).forEach(secKey => {
                categorySectionsState[secKey].keys = categorySectionsState[secKey].keys.filter(k => k !== catId);
            });
            
            // Retirer des r√©sultats courants
            delete currentDraw.results[catId];

            saveCategories();
            saveData();
            saveSections();
            
            updateCategorySelects();
            afficherCategories();
            afficherElements(); // Refresh item list if it was selected
            updateResultDOM(); // Refresh main UI
            
            showToast("Cat√©gorie supprim√©e");
            closeModal();
        }

        // --- GESTION LISTES ---
        function afficherElements() {
            const cat = document.getElementById('manage-category').value;
            const listDiv = document.getElementById('items-list');
            listDiv.innerHTML = '';
            
            if (!data[cat]) return;

            data[cat].forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `${item} <span class="delete-btn" onclick="supprimerElement('${cat}', ${index})">&times;</span>`;
                listDiv.appendChild(div);
            });
        }

        function supprimerElement(cat, index) {
            data[cat].splice(index, 1);
            saveData();
            afficherElements();
        }

        // --- MODAL Vider les listes (S√âLECTION) ---
        function showClearListsSelectionModal() {
            const container = document.getElementById('clearListsCheckboxes');
            container.innerHTML = '';

            Object.keys(categories).forEach(key => {
                const count = data[key] ? data[key].length : 0;
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${key}">
                    <span>${categories[key].icon} ${categories[key].label} <small>(${count} √©l√©ments)</small></span>
                `;
                container.appendChild(label);
            });

            document.getElementById('clearListsModal').style.display = 'block';
        }

        function clearSelectedLists() {
            const checkboxes = document.querySelectorAll('#clearListsCheckboxes input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("Veuillez s√©lectionner au moins une liste.");
                return;
            }

            let count = 0;
            checkboxes.forEach(cb => {
                const key = cb.value;
                if (data[key]) {
                    data[key] = []; // On vide le tableau
                    count++;
                }
            });

            saveData();
            closeModal('clearListsModal');
            showToast(`${count} liste(s) vid√©e(s) avec succ√®s.`);
            afficherElements(); // Rafraichir si ouvert
        }


        // --- RESET TOTAL ---
        function showFullResetModal() {
            showModal("‚ö†Ô∏è Attention ! Cela va √©craser TOUTES vos modifications (cat√©gories, items) et remettre les donn√©es d'usine. L'historique sera conserv√©.", () => {
                fullReset();
            });
        }

        function fullReset() {
            localStorage.removeItem('musicData_v4');
            localStorage.removeItem('musicCats_v4');
            localStorage.removeItem('musicSections_v4');
            localStorage.removeItem('musicDrawCounts_v4'); // Suppression des options de tirage
            // On recharge la page pour r√©initialiser proprement
            location.reload();
        }

        // --- HISTORIQUE ---
        function sauvegarderTirage() {
            const entry = {
                date: new Date().toLocaleString(),
                results: JSON.parse(JSON.stringify(currentDraw.results))
            };
            drawHistory.unshift(entry);
            if (drawHistory.length > 50) drawHistory.pop(); // Limite
            saveHistory();
            showToast("Tirage sauvegard√© !");
        }

        function afficherHistorique() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if (drawHistory.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666;">Aucun historique.</p>';
            } else {
                drawHistory.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    
                    let content = `<div class="history-item-header"><span>${entry.date}</span> <button class="secondary" style="font-size:0.8em; padding:2px 8px;" onclick="restaurerTirage(${index})">Recharger</button></div>`;
                    content += `<div style="display:flex; flex-wrap:wrap; gap:5px;">`;
                    
                    Object.keys(entry.results).forEach(key => {
                        // On essaie de r√©cup√©rer le label de la cat√©gorie, sinon on met la cl√©
                        const catLabel = categories[key] ? categories[key].label : key;
                        // On ignore duree et tempo pour l'affichage compact, ou on les met
                        if(key !== 'duree' && key !== 'tempo') {
                            content += `<span style="background:#ddd; padding:2px 6px; border-radius:4px; font-size:0.85em;"><b>${catLabel}:</b> ${entry.results[key]}</span>`;
                        }
                    });
                    
                    // Ajout Tempo/Dur√©e √† la fin
                    if(entry.results.tempo) content += `<span style="background:#b2dfdb; padding:2px 6px; border-radius:4px; font-size:0.85em;">‚ö° ${entry.results.tempo}</span>`;
                    
                    content += `</div>`;
                    div.innerHTML = content;
                    list.appendChild(div);
                });
            }
            
            document.getElementById('historyModal').style.display = 'block';
        }

        function restaurerTirage(index) {
            currentDraw.results = JSON.parse(JSON.stringify(drawHistory[index].results));
            applyValuesToDOM(currentDraw.results);
            closeHistoryModal();
            showToast("Tirage recharg√© !");
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function showClearHistoryModal() {
            if(confirm("Vider tout l'historique ?")) {
                drawHistory = [];
                saveHistory();
                afficherHistorique();
            }
        }

        // --- UI UTILS ---
        function copierResultat() {
            let text = `üéµ Id√©e Musicale (${currentDraw.date})\n\n`;
            
            // Ordre logique
            const orderedKeys = ['ambiances', 'styles', 'tempo', 'duree', 'signatures', 'tonalites'];
            
            // D'abord les cl√©s principales ordonn√©es
            orderedKeys.forEach(key => {
                if (currentDraw.results[key]) {
                    const label = categories[key] ? categories[key].label : (key === 'tempo' ? 'Tempo' : (key==='duree'?'Dur√©e':key));
                    text += `${label}: ${currentDraw.results[key]}\n`;
                }
            });
            
            // Ensuite le reste
            Object.keys(currentDraw.results).forEach(key => {
                if (currentDraw.results[key] && !orderedKeys.includes(key)) {
                    const label = categories[key] ? categories[key].label : key;
                    text += `${label}: ${currentDraw.results[key]}\n`;
                }
            });

            // Fallback for clipboard access in some environments
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            showToast("Copi√© dans le presse-papier !");
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            content.classList.toggle('active');
            content.previousElementSibling.classList.toggle('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        // Generic Modal
        function showModal(msg, callback) {
            document.getElementById('modal-message').innerText = msg;
            document.getElementById('confirmModal').style.display = 'block';
            modalCallback = callback;
        }

        function confirmAction() {
            if (modalCallback) modalCallback();
            closeModal();
        }

        function closeModal(id = 'confirmModal') {
            document.getElementById(id).style.display = 'none';
            if (id === 'confirmModal') modalCallback = null;
        }

        // Close modal on click outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>

